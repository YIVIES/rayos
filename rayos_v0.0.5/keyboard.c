#include "x86.h"

static uchar key_scancode[0x200][0x2] = {
    /* 0x00 key pressed */
    {'\0', '\0'},   // null
    {'\0', '\0'},   // esc
    {'1', '!'},
    {'2', '@'},
    {'3', '#'},
    {'4', '$'},
    {'5', '%'},
    {'6', '^'},
    {'7', '&'},
    {'8', '*'},
    {'9', '('},
    {'0', ')'},
    {'-', '_'},
    {'=', '+'},
    {'\b', '\b'},   // back
    {'\t', '\t'},   // tab
    {'q', 'Q'},
    {'w', 'W'},
    {'e', 'E'},
    {'r', 'R'},
    {'t', 'T'},
    {'y', 'Y'},
    {'u', 'U'},
    {'i', 'I'},
    {'o', 'O'},
    {'p', 'P'},
    {'[', '{'},
    {']', '}'},
    {'\n', '\n'},
    {'\0', '\0'},   // left ctrl
    {'a', 'A'},
    {'s', 'S'},
    {'d', 'D'},
    {'f', 'F'},
    {'g', 'G'},
    {'h', 'H'},
    {'j', 'J'},
    {'k', 'K'},
    {'l', 'L'},
    {';', ':'},
    {'\'', '\"'},
    {'`', '~'},
    {'\0', '\0'},   // left shift
    {'\\', '|'},
    {'z', 'Z'},
    {'x', 'X'},
    {'c', 'C'},
    {'v', 'V'},
    {'b', 'B'},
    {'n', 'N'},
    {'m', 'M'},
    {',', '<'},
    {'.', '>'},
    {'/', '?'},
    {'\0', '\0'},   // right shift
    {'*', '*'},    // keypad *
    {'\0', '\0'},    // left alt
    {' ', ' '},
    {'\0', '\0'},   // caps
    {'\0', '\0'},   // f1
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},   // f10
    {'\0', '\0'},   // num lock
    {'\0', '\0'},   // scroll lock
    /* keypad start */
    {'7', '\0'},   // keypad 7
    {'8', '\0'},
    {'9', '\0'},
    {'-', '\0'},    // keypad -
    {'4', '\0'},
    {'5', '\0'},
    {'6', '\0'},
    {'+', '\0'},    // keypad +
    {'1', '\0'},
    {'2', '\0'},
    {'3', '\0'},
    {'0', '\0'},
    {'.', '\0'},
    /* keypad end */
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},   // f11
    {'\0', '\0'},   // f12
    /* 0x59 */
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    /* 0x60 */
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    /* 0x70 */
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    {'\0', '\0'},
    /* 0x80 */
    {'\0', '\0'}
};

static uint key_shift = 0x0;

void init_keyboard(void)
{
    set_8259a_irq_mask(0xfffd);
}

void keyboard(void)
{
    outb(0x20, 0x20);
    uchar scan_code = inb(0x60);
    if (scan_code == 0x2a || scan_code == 0x36) {
        key_shift = 1;
        goto ret;
    }
    if (scan_code == 0xaa || scan_code == 0xb6) {
        key_shift = 0;
        goto ret;
    }
    putc(key_scancode[scan_code][key_shift]);
ret:
    outb(0x61, scan_code & 0x7f);
}